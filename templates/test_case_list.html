{% load static %}
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>测试用例管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="container mt-4">
    <h1>测试用例管理</h1>

    <button class="btn btn-primary mb-3" id="addProductBtn">新增用例</button>
    <!-- 在表格前添加筛选区域 -->
    <div class="row mb-3">
        <div class="col-md-3">
            <label class="form-label">项目名称</label>
            <select class="form-select" id="filterProduct">
                <option value="">请选择项目名称</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">页面</label>
            <select class="form-select" id="filterModel" disabled>
                <option value="">请选择页面</option>
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">用例名称</label>
            <div class="input-group">
                <input type="text" class="form-control" id="searchCase" placeholder="请输入用例名称">
                <button class="btn btn-primary" id="searchBtn">搜索</button>
            </div>
        </div>
        <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <button class="btn btn-secondary d-block" id="resetFilter">重置筛选</button>
        </div>
    </div>

    <table class="table table-bordered">
        <thead>
        <tr>
            <th>用例名称</th>
            <th>项目名称</th>
            <th>页面</th>
            <th>用例内容</th>
            <th>操作</th>
        </tr>
        </thead>

        <tbody id="caseTableBody">
        <!-- 数据将通过 JavaScript 动态加载 -->
        </tbody>

    </table>
</div>

<!-- 模态框 -->
<div class="modal fade" id="testCaseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">新增测试用例</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label>用例名称</label>
                    <input type="text" class="form-control" id="caseName" required>
                </div>
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label>项目名称</label>
                        <select class="form-select" id="productSelect">
                            <option value="">请选择项目...</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label>页面名称</label>
                        <select class="form-select" id="modelSelect" disabled>
                            <option value="">请先选择项目...</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="border p-2">
                            <h6>可选元素列表</h6>
                            <div id="elementList" class="list-group"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="border p-2">
                            <h6>已选元素（按顺序）</h6>
                            <div id="selectedElements" class="list-group"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveCase">保存用例</button>
            </div>
        </div>
    </div>
</div>

<script>

    $(document).ready(function () {
        // 初始化产品下拉框
        $.get("/element_management/check_case_list/", function (data) {
            $("#filterProduct").empty().append('<option value="">请选择项目名称</option>');
            data.products.forEach(p => {
                $("#filterProduct").append(`<option value="${p.product_name}">${p.product_name}</option>`);
            });
        });

        // 监听产品选择变化
        $("#filterProduct").change(function () {
            const product = $(this).val();
            $("#filterModel").prop("disabled", true).empty().append('<option value="">请选择页面</option>');

            if (product) {
                $.get("/element_management/check_case_list/", {
                    product_name: product
                }, function (data) {
                    $("#filterModel").empty().append('<option value="">请选择页面</option>');
                    // 添加"全部"选项
                    $("#filterModel").append('<option value="全部">全部</option>');

                    if (data.models && data.models.length > 0) {
                        data.models.forEach(model => {
                            $("#filterModel").append(`<option value="${model.model}">${model.model}</option>`);
                        });
                        $("#filterModel").prop("disabled", false);
                    }
                });
            }
        });


        // 监听页面选择变化，加载表格数据
        $("#filterModel").change(function () {
            loadTableData();
        });

        // 加载表格数据的函数
        function loadTableData() {
            const product = $("#filterProduct").val();
            const model = $("#filterModel").val();

            if (product && (model === "全部" || model)) {  // 修改判断条件以包含"全部"选项
                $.get("/element_management/check_case_list/", {
                    product_name: product,
                    model: model
                }, function (data) {
                    $("#caseTableBody").empty();
                    if (data.products && data.products.length > 0) {
                        data.products.forEach(item => {
                            $("#caseTableBody").append(`
                        <tr>
                            <td>${item.case_name}</td>
                            <td>${item.product_name}</td>
                            <td>${item.model}</td>
                            <td class="case-content">${item.element_details || ''}</td>
                            <td>
                                <button class="btn btn-warning btn-sm editProductBtn"
                                    data-id="${item.id}"
                                    data-name="${item.case_name}"
                                    data-product="${item.product_name}"
                                    data-model="${item.model}">编辑</button>
                                <button class="btn btn-danger btn-sm deleteProductBtn"
                                    data-id="${item.id}">删除</button>
                            </td>
                        </tr>
                    `);
                        });
                    }
                });
            }
        }

        // 重置筛选按钮
        $("#resetFilter").click(function () {
            $("#filterProduct").val("");
            $("#filterModel").val("").prop("disabled", true);
            $("#caseTableBody").empty();
        });
    });
    $(document).ready(function () {
        // 初始化产品列表
        $.get("/element_management/check_element_list/", function (data) {
            $("#productSelect").empty().append('<option value="">选择项目...</option>');
            data.products.forEach(p => {
                $("#productSelect").append(`<option value="${p.product_name}">${p.product_name}</option>`);
            });
        });


        // 监听产品选择框变化
        $("#productSelect").change(function () {
            const product = $(this).val();  // 获取选中的产品名称
            $("#modelSelect").prop("disabled", true).empty().append('<option value="">加载中...</option>');

            if (product) {
                // 请求后端获取该产品下的所有型号
                $.get("/element_management/check_element_list/", {product_name: product}, function (data) {
                    // 清空现有选项，并添加 "请选择型号" 提示
                    $("#modelSelect").empty().append('<option value="">请选择页面...</option>');

                    // 如果返回了型号列表
                    if (data.models && data.models.length > 0) {
                        // 填充型号数据
                        data.models.forEach(function (item) {
                            $("#modelSelect").append(`<option value="${item.model}">${item.model}</option>`);
                        });

                        // 启用型号选择框
                        $("#modelSelect").prop("disabled", false);
                    } else {
                        // 没有找到型号时的提示
                        alert("没有找到相关的型号");
                    }
                });
            } else {
                // 如果没有选择产品名称，清空型号选择框
                $("#modelSelect").prop("disabled", true).empty().append('<option value="">请选择页面...</option>');
            }
        });

// 在选择了产品和型号后加载匹配的数据
        $("#modelSelect").change(function () {
            const productName = $("#productSelect").val();
            const model = $(this).val();

            if (productName && model) {
                $.get("/element_management/check_element_list/", {
                    product_name: productName,
                    model: model
                }, function (data) {
                    $("#elementList").empty();

                    if (data.products && data.products.length > 0) {
                        data.products.forEach(function (item) {
                            // 改为可选择的列表项
                            $("#elementList").append(`
                        <a href="#" class="list-group-item element-item"
                           data-id="${item.id}"
                           data-function="${item.function}">
                            ${item.function} - ${item.text} - ${item.content_desc}
                            <small class="text-muted">(${item.remark})</small>
                        </a>
                    `);
                        });
                    } else {
                        $("#elementList").append('<div class="alert alert-info">没有匹配的元素</div>');
                    }
                });
            }
        });


        // 元素点击选择
        $("#elementList").on("click", ".element-item", function () {
            const clone = $(this).clone()
                .removeClass("element-item")
                .addClass("selected-item")
                .click(function () {
                    $(this).remove();
                });
            $("#selectedElements").append(clone);
        });

        // 保存用例
        $("#saveCase").click(function () {
            const caseName = $("#caseName").val();
            const productName = $("#productSelect").val();
            const model = $("#modelSelect").val();
            const elements = $("#selectedElements .selected-item").map(function () {
                return $(this).data("id");
            }).get();
            const functions = $("#selectedElements .selected-item").map(function () {
                return $(this).data("function");
            }).get().join(","); // 获取所有选中元素的function并用逗号连接

            if (!caseName || elements.length === 0) {
                alert("请填写用例名称并选择至少一个元素");
                return;
            }

            if (!productName || !model) {
                alert("请选择项目名称和页面");
                return;
            }

            // 构建请求数据
            const requestData = {
                case_name: caseName,
                product_name: productName,
                model: model,
                function: functions,
                element_id: elements
            };

            // 判断是新增还是编辑
            const isEdit = $("#testCaseModal").data("edit");
            const url = isEdit
                ? `/element_management/edit_product/${$("#testCaseModal").data("caseId")}/`
                : "/element_management/add_test_case/";

            $.ajax({
                url: url,
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(requestData),
                success: (res) => {
                    if (res.status === "success") {
                        location.reload();
                    } else {
                        alert("保存失败：" + res.message);
                    }
                },
                error: () => alert("请求失败，请检查网络")
            });
        });

        // 新增按钮点击事件
        $("#addProductBtn").click(function () {
            // 重置表单
            $("#caseName").val("");
            $("#selectedElements").empty();
            $("#productSelect").val("");
            $("#modelSelect").val("").prop("disabled", true);
            $("#elementList").empty();

            // 修改模态框标题
            $(".modal-title").text("新增测试用例");

            // 显示模态框
            $("#testCaseModal").modal("show");
        });

        // 编辑按钮点击事件
        $(".editProductBtn").click(function () {
            const caseId = $(this).data("id");
            const caseName = $(this).data("name");
            const productName = $(this).data("product");
            const model = $(this).data("model");

            // 填充模态框
            $("#caseName").val(caseName);
            $("#productSelect").val(productName);

            // 触发产品选择框的change事件，加载对应的型号
            $("#productSelect").trigger("change");

            // 等待型号加载完成后设置选中的型号
            setTimeout(() => {
                $("#modelSelect").val(model);
                $("#modelSelect").trigger("change");
            }, 500);

            // 清空已选元素列表
            $("#selectedElements").empty();

            // 标记当前是编辑模式
            $("#testCaseModal").data("edit", true).data("caseId", caseId);

            // 修改模态框标题
            $(".modal-title").text("编辑测试用例");

            // 显示模态框
            $("#testCaseModal").modal("show");
        });

// 新增按钮点击事件
        $("#addProductBtn").click(function () {
            // 重置表单
            $("#caseName").val("");
            $("#selectedElements").empty();
            $("#productSelect").val("");
            $("#modelSelect").val("").prop("disabled", true);
            $("#elementList").empty();

            // 标记当前是新增模式
            $("#testCaseModal").data("edit", false).removeData("caseId");

            // 修改模态框标题
            $(".modal-title").text("新增测试用例");

            // 显示模态框
            $("#testCaseModal").modal("show");
        });

// 为了支持删除已选元素，添加点击事件
        $("#selectedElements").on("click", ".text-danger", function (e) {
            e.preventDefault();
            $(this).closest(".list-group-item").remove();
        });
        // 删除按钮点击事件
        $(".deleteProductBtn").click(function () {
            const caseId = $(this).data("id");

            if (confirm("确定要删除这个测试用例吗？")) {
                $.ajax({
                    url: `/element_management/delete_case_list/${caseId}/`,
                    type: "POST",
                    headers: {
                        "X-CSRFToken": getCookie("csrftoken")  // 添加CSRF token
                    },
                    success: function (response) {
                        if (response.status === "success") {
                            $(this).closest("tr").remove();
                            location.reload();
                        } else {
                            alert("删除失败：" + response.message);
                        }
                    },
                    error: function () {
                        alert("删除失败，请检查网络连接");
                    }
                });
            }
        });
        // 使用事件委托处理编辑按钮点击
        $(document).on("click", ".editProductBtn", function () {
            const caseId = $(this).data("id");
            const caseName = $(this).data("name");
            const productName = $(this).data("product");
            const model = $(this).data("model");

            // 填充模态框
            $("#caseName").val(caseName);
            $("#productSelect").val(productName);

            // 触发产品选择框的change事件，加载对应的型号
            $("#productSelect").trigger("change");

            // 等待型号加载完成后设置选中的型号
            setTimeout(() => {
                $("#modelSelect").val(model);
                $("#modelSelect").trigger("change");
            }, 500);

            // 清空已选元素列表
            $("#selectedElements").empty();

            // 标记当前是编辑模式
            $("#testCaseModal").data("edit", true).data("caseId", caseId);

            // 修改模态框标题
            $(".modal-title").text("编辑测试用例");

            // 显示模态框
            $("#testCaseModal").modal("show");
        });

        // 使用事件委托处理删除按钮点击
        $(document).on("click", ".deleteProductBtn", function () {
            const caseId = $(this).data("id");

            if (confirm("确定要删除这个测试用例吗？")) {
                $.ajax({
                    url: `/element_management/delete_case_list/${caseId}/`,
                    type: "POST",
                    headers: {
                        "X-CSRFToken": getCookie("csrftoken")
                    },
                    success: function (response) {
                        if (response.status === "success") {
                            // 重新加载表格数据
                            loadTableData();
                        } else {
                            alert("删除失败：" + response.message);
                        }
                    },
                    error: function () {
                        alert("删除失败，请检查网络连接");
                    }
                });
            }
        });

        // 修改 loadTableData 函数，确保生成的HTML包含所有必要的数据属性
        function loadTableData() {
            const product = $("#filterProduct").val();
            const model = $("#filterModel").val();

            if (product && model) {
                $.get("/element_management/check_case_list/", {
                    product_name: product,
                    model: model
                }, function (data) {
                    $("#caseTableBody").empty();
                    if (data.products && data.products.length > 0) {
                        data.products.forEach(item => {
                            $("#caseTableBody").append(`
                            <tr>
                                <td>${item.case_name}</td>
                                <td>${item.product_name}</td>
                                <td>${item.model}</td>
                                <td class="case-content">${item.element_details || ''}</td>
                                <td>
                                    <button class="btn btn-warning btn-sm editProductBtn"
                                        data-id="${item.id}"
                                        data-name="${item.case_name}"
                                        data-product="${item.product_name}"
                                        data-model="${item.model}">编辑</button>
                                    <button class="btn btn-danger btn-sm deleteProductBtn"
                                        data-id="${item.id}">删除</button>
                                </td>
                            </tr>
                        `);
                        });
                    }
                });
            }
        }

        // 添加搜索按钮的点击事件
        $("#searchBtn").click(function () {
            const searchKeyword = $("#searchCase").val().trim();
            if (searchKeyword) {
                searchCases(searchKeyword);
            } else {
                // 如果搜索框为空，恢复显示筛选结果
                loadTableData();
            }
        });

// 添加搜索框的回车事件
        $("#searchCase").keypress(function (e) {
            if (e.which === 13) {  // 回车键的 keyCode 是 13
                $("#searchBtn").click();
            }
        });

// 搜索功能实现
        function searchCases(keyword) {
            $.get("/element_management/search_case/", {
                search_keyword: keyword
            }, function (response) {
                $("#caseTableBody").empty();

                if (response.products && response.products.length > 0) {
                    response.products.forEach(item => {
                        $("#caseTableBody").append(`
                    <tr>
                        <td>${item.case_name}</td>
                        <td>${item.product_name}</td>
                        <td>${item.model}</td>
                        <td class="case-content">${item.element_details || ''}</td>
                        <td>
                            <button class="btn btn-warning btn-sm editProductBtn"
                                data-id="${item.id}"
                                data-name="${item.case_name}"
                                data-product="${item.product_name}"
                                data-model="${item.model}">编辑</button>
                            <button class="btn btn-danger btn-sm deleteProductBtn"
                                data-id="${item.id}">删除</button>
                        </td>
                    </tr>
                `);
                    });
                } else {
                    $("#caseTableBody").append(`
                <tr>
                    <td colspan="5" class="text-center">未找到匹配的测试用例</td>
                </tr>
            `);
                }
            }).fail(function () {
                alert("搜索请求失败，请检查网络连接");
            });
        }

// 重置筛选按钮，同时清空搜索框
        $("#resetFilter").click(function () {
            $("#filterProduct").val("");
            $("#filterModel").val("").prop("disabled", true);
            $("#searchCase").val("");  // 清空搜索框
            $("#caseTableBody").empty();
        });

// 获取CSRF token的函数
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
