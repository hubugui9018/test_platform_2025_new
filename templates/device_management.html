{% load static %}
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>设备管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<div class="container mt-4">
    <h1>设备管理</h1>

    <button class="btn btn-primary mb-3" id="addDeviceBtn">新增设备</button>

    <table class="table table-bordered">
        <thead>
        <tr>
            <th>设备名称</th>
            <th>设备类型</th>
            <th>IP 地址</th>
            <th>端口号</th>
            <th>状态</th>
            <th>唯一 ID</th>
            <th>操作</th>
        </tr>
        </thead>
        <tbody>
        {% for device in devices %}
            <tr>
                <td>{{ device.name }}</td>
                <td>{{ device.device_type }}</td>
                <td>{{ device.ip_address }}</td>
                <td>{{ device.port_num }}</td>
                <td>{{ device.status }}</td>
                <td>{{ device.unique_id }}</td>
                <td>
                    <button class="btn btn-success btn-sm connectDeviceBtn" data-id="{{ device.id }}">连接</button>
                    <button class="btn btn-warning btn-sm editDeviceBtn" data-id="{{ device.id }}"
                            data-name="{{ device.name }}" data-type="{{ device.device_type }}"
                            data-ip="{{ device.ip_address }}" data-port="{{ device.port_num }}"
                            data-status="{{ device.status }}" data-unique="{{ device.unique_id }}">编辑
                    </button>
                    <button class="btn btn-danger btn-sm deleteDeviceBtn" data-id="{{ device.id }}">删除</button>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<!-- 新增/编辑模态框 -->
<div class="modal fade" id="deviceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">新增设备</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="deviceId">
                <div class="mb-3">
                    <label for="deviceName" class="form-label">设备名称</label>
                    <input type="text" class="form-control" id="deviceName" required>
                </div>
                <div class="mb-3">
                    <label for="deviceType" class="form-label">设备类型</label>
                    <input type="text" class="form-control" id="deviceType" required>
                </div>
                <div class="mb-3">
                    <label for="deviceIp" class="form-label">IP 地址</label>
                    <input type="text" class="form-control" id="deviceIp" required>
                </div>
                <div class="mb-3">
                    <label for="devicePort" class="form-label">端口号</label>
                    <input type="number" class="form-control" id="devicePort" required>
                </div>
                <div class="mb-3">
                    <label for="deviceStatus" class="form-label">状态</label>
                    <input type="text" class="form-control" id="deviceStatus">
                </div>
                <div class="mb-3">
                    <label for="deviceUniqueId" class="form-label">唯一 ID</label>
                    <input type="text" class="form-control" id="deviceUniqueId">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveDeviceBtn">保存</button>
            </div>
        </div>
    </div>
</div>

<script>
    $("#addDeviceBtn").click(function () {
        $("#modalTitle").text("新增设备");
        $("#deviceId").val("");
        $("#deviceName").val("");
        $("#deviceType").val("");
        $("#deviceIp").val("");
        $("#devicePort").val("");
        $("#deviceStatus").val("");
        $("#deviceUniqueId").val("");
        var myModal = new bootstrap.Modal(document.getElementById('deviceModal'));
        myModal.show();
    });

    $(".editDeviceBtn").click(function () {
        $("#modalTitle").text("编辑设备");
        $("#deviceId").val($(this).data("id"));
        $("#deviceName").val($(this).data("name"));
        $("#deviceType").val($(this).data("type"));
        $("#deviceIp").val($(this).data("ip"));
        $("#devicePort").val($(this).data("port"));
        $("#deviceStatus").val($(this).data("status"));
        $("#deviceUniqueId").val($(this).data("unique"));
        var myModal = new bootstrap.Modal(document.getElementById('deviceModal'));
        myModal.show();
    });

    $("#saveDeviceBtn").click(function () {
        let deviceId = $("#deviceId").val();
        let url = deviceId ? `/device_management/edit/${deviceId}/` : "/device_management/add/";
        let data = {
            name: $("#deviceName").val(),
            device_type: $("#deviceType").val(),
            ip_address: $("#deviceIp").val(),
            port_num: $("#devicePort").val(),
            status: $("#deviceStatus").val(),
            unique_id: $("#deviceUniqueId").val()
        };

        $.ajax({
            url: url,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function (response) {
                alert(response.message);
                location.reload();
            }
        });
    });

    $(".deleteDeviceBtn").click(function () {
        if (confirm("确定删除该设备？")) {
            $.post(`/device_management/delete/${$(this).data("id")}/`, function (response) {
                alert(response.message);
                location.reload();
            });
        }
    });

    $(".connectDeviceBtn").click(function () {
        let deviceId = $(this).data("id");

        $.ajax({
            url: `/device_management/connect/${deviceId}/`,
            type: "GET",
            dataType: "json",  // 确保返回的数据被解析为 JSON
            success: function (response) {
                console.log("Response:", response);  // 在控制台打印返回值，检查是否为 JSON
                if (response.status === "success") {
                    window.location.href = response.redirect_url;  // 跳转并带上设备名称
                } else {
                    alert(response.message);
                }
            },
            error: function (xhr) {
                console.error("Error:", xhr.responseText);
                alert(xhr.responseJSON ? xhr.responseJSON.message : "设备连接失败！");
            }
        });
    });


</script>

</body>
</html>
